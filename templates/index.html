<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Discord Bot Control</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .tab { cursor: pointer; }
        .tab.active { font-weight: bold; }
        .guild-tabs, .channels, .controls { margin-top: 20px; }
        .hidden { display: none; }
        .btn-sound { margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="my-4 text-center">Discord Bot Control</h1>
        
        <!-- Message Box -->
        <div id="messageBox" class="alert alert-info" style="display: none;"></div>

        <!-- Buttons to switch between Servers and Logs -->
        <div class="btn-group mb-3" role="group">
            <button id="showServers" class="btn btn-primary" onclick="showSection('servers')">Servers</button>
            <button id="showLogs" class="btn btn-secondary" onclick="showSection('logs')">Logs</button>
        </div>
        
        <!-- Servers view -->
        <div id="serversSection" class="section">
            <!-- Guild tabs -->
            <div id="guilds" class="nav nav-tabs guild-tabs">
                <!-- Guild tabs will be loaded here dynamically -->
            </div>
            
            <!-- Controls for sound and disconnecting -->
            <div id="controls" class="controls">
                <button class="btn btn-danger" onclick="leaveChannel()">Leave Voice Channel</button>
                <button class="btn btn-secondary" onclick="stopPlaying()">Stop Playing</button>
                <div id="soundButtons" class="mt-2">
                    <!-- Sound buttons will be loaded here dynamically -->
                </div>
            </div>
            
            <!-- Channels list with join buttons -->
            <div id="channels" class="channels">
                <div class="alert alert-info">Select a server to see its channels.</div>
            </div>
        </div>

        <!-- Logs view -->
        <div id="logsSection" class="section hidden">
            <!-- Log messages display -->
            <div id="logs" class="logs">
                <div class="alert alert-info">Logs will be displayed here.</div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let selectedGuildId = null;
        let selectedChannelId = null;
        let lastLogId = 0;  // Store the last received log ID

        function showSection(section) {
            document.getElementById('serversSection').classList.add('hidden');
            document.getElementById('logsSection').classList.add('hidden');
            document.getElementById('showServers').classList.remove('btn-primary');
            document.getElementById('showLogs').classList.remove('btn-primary');
            document.getElementById('showServers').classList.add('btn-secondary');
            document.getElementById('showLogs').classList.add('btn-secondary');

            if (section === 'servers') {
                document.getElementById('serversSection').classList.remove('hidden');
                document.getElementById('showServers').classList.add('btn-primary');
            } else if (section === 'logs') {
                document.getElementById('logsSection').classList.remove('hidden');
                document.getElementById('showLogs').classList.add('btn-primary');
            }
        }

        function displayMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            messageBox.innerText = message;
            messageBox.className = `alert alert-${type}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        async function loadGuilds() {
            const response = await fetch('/api/guilds');
            const guilds = await response.json();
            const guildsContainer = document.getElementById('guilds');
            guildsContainer.innerHTML = '';

            guilds.forEach(guild => {
                const guildTab = document.createElement('a');
                guildTab.className = 'nav-item nav-link tab';
                guildTab.innerText = guild.name;
                guildTab.onclick = () => {
                    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                    guildTab.classList.add('active');
                    selectedGuildId = guild.id;
                    loadChannels(guild.id);
                };
                guildsContainer.appendChild(guildTab);
            });
        }

        async function loadChannels(guildId) {
            const response = await fetch(`/api/channels/${guildId}`);
            const channels = await response.json();
            const channelsContainer = document.getElementById('channels');
            channelsContainer.innerHTML = '';

            if (channels.error) {
                displayMessage(channels.error, 'danger');
            } else {
                channelsContainer.innerHTML = '';
                channels.forEach(channel => {
                    const channelRow = document.createElement('div');
                    channelRow.className = 'd-flex justify-content-between align-items-center mb-2';
                    
                    const channelName = document.createElement('span');
                    channelName.innerText = channel.name;

                    const joinButton = document.createElement('button');
                    joinButton.className = 'btn btn-primary ml-2';
                    joinButton.innerText = 'Join Channel';
                    joinButton.onclick = () => joinChannel(guildId, channel.id);

                    channelRow.appendChild(channelName);
                    channelRow.appendChild(joinButton);
                    channelsContainer.appendChild(channelRow);
                });
            }
        }

        async function displayControls() {
            const controlsContainer = document.getElementById('soundButtons');
            controlsContainer.innerHTML = '';

            const response = await fetch('/api/sounds');
            const sounds = await response.json();

            sounds.forEach(sound => {
                const playButton = document.createElement('button');
                playButton.className = 'btn btn-secondary btn-sound';
                playButton.innerText = `Play ${sound}`;
                playButton.onclick = () => playSound(sound);
                controlsContainer.appendChild(playButton);
            });
        }

        async function joinChannel(guildId, channelId) {
            const response = await fetch('/api/join', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ guildId, channelId })
            });
            const result = await response.json();
            if (response.ok) {
                selectedChannelId = channelId;
                displayMessage(result.message, 'success');
            } else {
                displayMessage(result.error || 'Failed to join the channel', 'danger');
            }
        }

        async function leaveChannel() {
            const response = await fetch('/api/leave', { method: 'POST' });
            const result = await response.json();
            if (response.ok) {
                selectedChannelId = null;
                displayMessage(result.message, 'success');
            } else {
                displayMessage(result.error || 'Failed to leave the channel', 'danger');
            }
        }

        async function stopPlaying() {
            const response = await fetch('/api/stop', { method: 'POST' });
            const result = await response.json();
            if (response.ok) {
                displayMessage(result.message, 'success');
            } else {
                displayMessage(result.error || 'Failed to stop playing', 'danger');
            }
        }

        async function playSound(sound) {
            if (!selectedGuildId || !selectedChannelId) {
                displayMessage('Please join a voice channel first.', 'warning');
                return;
            }
            const response = await fetch('/api/play', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ guildId: selectedGuildId, sound })
            });
            const result = await response.json();
            if (response.ok) {
                displayMessage(result.message, 'success');
            } else {
                displayMessage(result.error || 'Failed to play the sound', 'danger');
            }
        }

        async function fetchLogs() {
            const response = await fetch(`/api/logs?last_log_id=${lastLogId}`);
            const logs = await response.json();

            // Append new logs and update lastLogId
            const logsContainer = document.getElementById('logs');
            Object.values(logs).forEach(log => {
                const logElement = document.createElement('div');
                logElement.className = `alert alert-${getLogSeverity(log.severity)}`;
                logElement.innerText = `${log.timestamp} - ${log.message}`;
                logsContainer.appendChild(logElement);
                lastLogId = Math.max(lastLogId, log.id);
            });
        }

        function getLogSeverity(severity) {
            switch (severity.toLowerCase()) {
                case 'debug': return 'secondary';
                case 'info': return 'primary';
                case 'warning': return 'warning';
                case 'error': return 'danger';
                case 'critical': return 'dark';
                default: return 'light';
            }
        }

        // Fetch logs periodically
        setInterval(fetchLogs, 3000);

        // Initialize on page load
        loadGuilds();
        displayControls();
        showSection('servers');
    </script>
</body>
</html>
